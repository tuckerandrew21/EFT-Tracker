{"version":3,"sources":["../../../../../apps/web/src/lib/security-logger.ts"],"sourcesContent":["import { prisma } from \"./prisma\";\nimport { logger } from \"./logger\";\nimport crypto from \"crypto\";\nimport type { SecurityEventType } from \"@prisma/client\";\n\ninterface SecurityEventData {\n  type: SecurityEventType;\n  userId?: string;\n  email?: string;\n  ipAddress: string;\n  userAgent?: string;\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * Log a security event to the database\n * Automatically hashes email addresses for privacy\n * Triggers alerts for suspicious activity\n */\nexport async function logSecurityEvent(data: SecurityEventData) {\n  try {\n    // Hash email for privacy (can still correlate events without storing PII)\n    const emailHash = data.email\n      ? crypto.createHash(\"sha256\").update(data.email).digest(\"hex\")\n      : undefined;\n\n    await prisma.securityEvent.create({\n      data: {\n        type: data.type,\n        userId: data.userId,\n        ipAddress: data.ipAddress,\n        userAgent: data.userAgent,\n        metadata: {\n          ...data.metadata,\n          emailHash,\n        },\n      },\n    });\n\n    // Check for suspicious activity patterns\n    if (data.type === \"LOGIN_FAILED\") {\n      await checkFailedLoginThreshold(data.ipAddress);\n    }\n\n    if (data.type === \"RATE_LIMIT_EXCEEDED\") {\n      await checkRateLimitPattern(data.ipAddress);\n    }\n  } catch (error) {\n    // Don't fail the request if logging fails\n    logger.error(\n      { error, eventType: data.type },\n      \"Failed to log security event\"\n    );\n  }\n}\n\n/**\n * Check if an IP has exceeded the failed login threshold\n * Alert if >10 failed logins in the last hour\n */\nasync function checkFailedLoginThreshold(ipAddress: string) {\n  const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);\n\n  const failedAttempts = await prisma.securityEvent.count({\n    where: {\n      type: \"LOGIN_FAILED\",\n      ipAddress,\n      createdAt: { gte: oneHourAgo },\n    },\n  });\n\n  if (failedAttempts >= 10) {\n    logger.warn(\n      { ipAddress, failedAttempts },\n      \"Suspicious login activity detected - possible brute force attack\"\n    );\n  }\n}\n\n/**\n * Check if an IP is repeatedly hitting rate limits\n * Alert if >5 rate limit violations in 15 minutes\n */\nasync function checkRateLimitPattern(ipAddress: string) {\n  const fifteenMinutesAgo = new Date(Date.now() - 15 * 60 * 1000);\n\n  const rateLimitHits = await prisma.securityEvent.count({\n    where: {\n      type: \"RATE_LIMIT_EXCEEDED\",\n      ipAddress,\n      createdAt: { gte: fifteenMinutesAgo },\n    },\n  });\n\n  if (rateLimitHits >= 5) {\n    logger.warn(\n      { ipAddress, rateLimitHits },\n      \"Repeated rate limit violations - possible automated attack\"\n    );\n  }\n}\n\n/**\n * Get security events for a user (for security dashboard)\n */\nexport async function getUserSecurityEvents(userId: string, limit = 50) {\n  return prisma.securityEvent.findMany({\n    where: { userId },\n    orderBy: { createdAt: \"desc\" },\n    take: limit,\n  });\n}\n\n/**\n * Get security events for an IP address (for investigation)\n */\nexport async function getIpSecurityEvents(ipAddress: string, limit = 50) {\n  return prisma.securityEvent.findMany({\n    where: { ipAddress },\n    orderBy: { createdAt: \"desc\" },\n    take: limit,\n  });\n}\n"],"names":[],"mappings":"o0CAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,gBAiBO,eAAe,EAAiB,CAAuB,EAC5D,GAAI,CAEF,IAAM,EAAY,EAAK,KAAK,CACxB,EAAA,OAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,EAAK,KAAK,EAAE,MAAM,CAAC,YACtD,CAEJ,OAAM,EAAA,MAAM,CAAC,aAAa,CAAC,MAAM,CAAC,CAChC,KAAM,CACJ,KAAM,EAAK,IAAI,CACf,OAAQ,EAAK,MAAM,CACnB,UAAW,EAAK,SAAS,CACzB,UAAW,EAAK,SAAS,CACzB,SAAU,CACR,GAAG,EAAK,QAAQ,WAChB,CACF,CACF,CACF,GAGkB,gBAAgB,CAA9B,EAAK,IAAI,EACX,MAAM,EAA0B,EAAK,SAAS,EAG9B,uBAAuB,CAArC,EAAK,IAAI,EACX,MAAM,EAAsB,EAAK,SAAS,CAE9C,CAAE,MAAO,EAAO,CAEd,EAAA,MAAM,CAAC,KAAK,CACV,OAAE,EAAO,UAAW,EAAK,IAAI,AAAC,EAC9B,+BAEJ,CACF,CAMA,eAAe,EAA0B,CAAiB,EACxD,IAAM,EAAa,IAAI,KAAK,KAAK,GAAG,GAAK,KAAK,CAExC,EAAiB,EAF4B,IAEtB,EAAA,MAAM,CAAC,aAAa,CAAC,KAAK,CAAC,CACtD,MAAO,CACL,KAAM,yBACN,EACA,UAAW,CAAE,IAAK,CAAW,CAC/B,CACF,GAEI,GAAkB,IAAI,AACxB,EAAA,MAAM,CAAC,IAAI,CACT,WAAE,EAAW,gBAAe,EAC5B,mEAGN,CAMA,eAAe,EAAsB,CAAiB,EACpD,IAAM,EAAoB,IAAI,KAAK,KAAK,GAAG,GAAK,KAAK,AAE/C,EAAgB,GAFoC,GAE9B,EAAA,MAAM,CAAC,aAAa,CAAC,KAAK,CAAC,CACrD,MAAO,CACL,KAAM,gCACN,EACA,UAAW,CAAE,IAAK,CAAkB,CACtC,CACF,GAEI,GAAiB,GAAG,AACtB,EAAA,MAAM,CAAC,IAAI,CACT,WAAE,gBAAW,CAAc,EAC3B,6DAGN"}