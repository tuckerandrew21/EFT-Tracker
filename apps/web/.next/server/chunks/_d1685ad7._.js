module.exports=[57026,e=>e.a(async(t,r)=>{try{var a=e.i(82570),s=e.i(14235),n=e.i(53707),o=e.i(19660),i=e.i(18387),u=t([s,n]);[s,n]=u.then?(await u)():u;let c=o.z.object({targetQuests:o.z.array(o.z.string().min(1)).min(1).max(100),playerLevel:o.z.number().int().min(1).max(79),confirmedBranches:o.z.array(o.z.string().min(1)).max(100).default([])});function l(e,t,r,a){if(a.has(e))return[];a.add(e);let s=t.get(e);if(!s)return[];let n=[];for(let e of s.dependsOn||[]){let s=e.requiredQuest.id,o=l(s,t,r,a);n.push(...o);let i=r.get(s);"COMPLETED"!==i&&n.push(s)}return n}async function d(e){try{let t=await (0,n.auth)();if(!t?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});let r=await e.json(),{targetQuests:o,playerLevel:u,confirmedBranches:d}=c.parse(r),p=await s.prisma.quest.findMany({include:{dependsOn:{include:{requiredQuest:!0}}}}),h=new Map(p.map(e=>[e.id,e]));for(let e of o)if(!h.has(e))return a.NextResponse.json({error:`Quest not found: ${e}`},{status:404});let f=await s.prisma.questProgress.findMany({where:{userId:t.user.id}}),g=new Map(f.map(e=>[e.questId,e.status])),E=new Set,w=new Set;for(let e of o)l(e,h,g,w).forEach(e=>E.add(e));let m=new Set(o);m.forEach(e=>E.delete(e));let R=new Set,y=new Set;for(let e of d)h.has(e)&&(R.add(e),l(e,h,g,y).forEach(e=>R.add(e)));R.forEach(e=>{E.has(e)&&R.delete(e)}),m.forEach(e=>R.delete(e));let v=new Set;for(let e of o)!function e(t,r){if(!r.has(t))for(let a of(r.add(t),p))a.dependsOn?.some(e=>e.requiredQuest.id===t)&&(v.add(a.id),e(a.id,r))}(e,new Set);let C=[],x=Array.from(E);if(x.length>0)for(let e=0;e<x.length;e+=50){let r=x.slice(e,e+50);try{await s.prisma.$transaction(async e=>{for(let a of r)await e.questProgress.upsert({where:{userId_questId:{userId:t.user.id,questId:a}},create:{userId:t.user.id,questId:a,status:"COMPLETED",syncSource:"WEB"},update:{status:"COMPLETED",syncSource:"WEB"}})},{timeout:3e4}),C.push(...r)}catch(a){throw i.logger.error({err:a,chunk:r.length,userId:t.user.id},"Transaction failed for prerequisite chunk"),Error(`Failed to complete prerequisite quests (chunk ${e/50+1})`)}}let I=[],A=Array.from(R);if(A.length>0)for(let e=0;e<A.length;e+=50){let r=A.slice(e,e+50);try{await s.prisma.$transaction(async e=>{for(let a of r)await e.questProgress.upsert({where:{userId_questId:{userId:t.user.id,questId:a}},create:{userId:t.user.id,questId:a,status:"COMPLETED",syncSource:"WEB"},update:{status:"COMPLETED",syncSource:"WEB"}})},{timeout:3e4}),I.push(...r)}catch(a){throw i.logger.error({err:a,chunk:r.length,userId:t.user.id},"Transaction failed for branch quest chunk"),Error(`Failed to complete branch quests (chunk ${e/50+1})`)}}let P=new Set;for(let e of p){if(m.has(e.id)||E.has(e.id)||R.has(e.id)||v.has(e.id)||e.levelRequired>u)continue;let t=g.get(e.id);"COMPLETED"!==t&&P.add(e.id)}let T=[],q=Array.from(P);if(q.length>0)for(let e=0;e<q.length;e+=50){let r=q.slice(e,e+50);try{await s.prisma.$transaction(async e=>{for(let a of r)await e.questProgress.upsert({where:{userId_questId:{userId:t.user.id,questId:a}},create:{userId:t.user.id,questId:a,status:"COMPLETED",syncSource:"WEB"},update:{status:"COMPLETED",syncSource:"WEB"}})},{timeout:3e4}),T.push(...r)}catch(a){throw i.logger.error({err:a,chunk:r.length,userId:t.user.id},"Transaction failed for level-based completion chunk"),Error(`Failed to complete level-based quests (chunk ${e/50+1})`)}}let S=[];if(o.length>0)for(let e=0;e<o.length;e+=50){let r=o.slice(e,e+50),a=[];try{await s.prisma.$transaction(async e=>{for(let s of r){let r=g.get(s);"COMPLETED"!==r&&(await e.questProgress.upsert({where:{userId_questId:{userId:t.user.id,questId:s}},create:{userId:t.user.id,questId:s,status:"AVAILABLE",syncSource:"WEB"},update:{status:"AVAILABLE",syncSource:"WEB"}}),a.push(s))}},{timeout:3e4}),S.push(...a)}catch(a){throw i.logger.error({err:a,chunk:r.length,userId:t.user.id},"Transaction failed for target quest chunk"),Error(`Failed to mark target quests as available (chunk ${e/50+1})`)}}return a.NextResponse.json({success:!0,completed:C,completedBranches:I,levelCompleted:T,available:S,totalChanged:C.length+I.length+T.length+S.length})}catch(e){if(e instanceof o.z.ZodError)return a.NextResponse.json({error:e.issues[0].message},{status:400});return i.logger.error({err:e},"Error in catch-up sync:"),a.NextResponse.json({error:"Failed to sync progress"},{status:500})}}e.s(["POST",()=>d]),r()}catch(e){r(e)}},!1),34108,e=>e.a(async(t,r)=>{try{var a=e.i(21777),s=e.i(50196),n=e.i(48215),o=e.i(53098),i=e.i(56531),u=e.i(44697),l=e.i(82719),d=e.i(73958),c=e.i(54135),p=e.i(68677),h=e.i(85985),f=e.i(11293),g=e.i(36964),E=e.i(33986),w=e.i(55543),m=e.i(19386),R=e.i(93695);e.i(82304);var y=e.i(27272),v=e.i(57026),C=t([v]);[v]=C.then?(await C)():C;let A=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/progress/catch-up/route",pathname:"/api/progress/catch-up",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/web/src/app/api/progress/catch-up/route.ts",nextConfigOutput:"standalone",userland:v}),{workAsyncStorage:P,workUnitAsyncStorage:T,serverHooks:q}=A;function x(){return(0,n.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:T})}async function I(e,t,r){A.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/progress/catch-up/route";a=a.replace(/\/index$/,"")||"/";let n=await A.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:C,nextConfig:x,parsedUrl:I,isDraftMode:P,prerenderManifest:T,routerServerContext:q,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,resolvedPathname:b,clientReferenceManifest:M,serverActionsManifest:N}=n,k=(0,d.normalizeAppPath)(a),_=!!(T.dynamicRoutes[k]||T.routes[b]),D=async()=>((null==q?void 0:q.render404)?await q.render404(e,t,I,!1):t.end("This page could not be found"),null);if(_&&!P){let e=!!T.routes[b],t=T.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await D();throw new R.NoFallbackError}}let L=null;!_||A.isDev||P||(L=b,L="/index"===L?"/":L);let $=!0===A.isDev||!_,B=_&&!$;N&&M&&(0,u.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:M,serverActionsManifest:N,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:N})});let H=e.method||"GET",U=(0,i.getTracer)(),j=U.getActiveScopeSpan(),F={params:C,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>A.onRequestError(e,t,a,q)},sharedContext:{buildId:v}},W=new c.NodeNextRequest(e),z=new c.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(W,(0,p.signalFromNodeResponse)(t));try{let n=async e=>A.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${H} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${a}`)}),u=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var i,l;let d=async({previousCacheEntry:s})=>{try{if(!u&&S&&O&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(o);e.fetchMetrics=F.renderOpts.fetchMetrics;let i=F.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let l=F.renderOpts.collectedTags;if(!_)return await (0,g.sendResponse)(W,z,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,s=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:S})},q),t}},c=await A.handleResponse({req:e,nextConfig:x,cacheKey:L,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:u});if(!_)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",S?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,E.fromNodeOutgoingHttpHeaders)(c.value.headers);return u&&_||p.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,w.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(W,z,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};j?await l(j):await U.withPropagatedContext(e.headers,()=>U.trace(h.BaseServerSpan.handleRequest,{spanName:`${H} ${a}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof R.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:S})}),_)throw t;return await (0,g.sendResponse)(W,z,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>x,"routeModule",()=>A,"serverHooks",()=>q,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>T]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_d1685ad7._.js.map