[variables]
# Build cache buster: 2025-12-17-02:25 (ensures .nixpacksignore fix is applied)
# Force Node.js 22.12 to match Prisma requirements
NIXPACKS_NODE_VERSION = "22.12.0"
# Force pnpm 10.0.0+ to match package.json engines requirement
NIXPACKS_PNPM_VERSION = "10.0.0"
# Disable automatic detection of Chromium/Playwright system packages
# These are only needed for testing, not production
NIXPACKS_NO_CHROMEDRIVER = "1"
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD = "1"
NODE_ENV = "production"

[phases.setup]
# Override default APT packages to exclude Chromium and test dependencies
# Nixpacks auto-detects these from pnpm-lock.yaml but they're only for E2E tests
aptPkgs = []
# Install pnpm 10.x instead of auto-detected 9.x
# Our package.json requires pnpm >=10.0.0
nixPkgs = ["nodejs_22", "pnpm-10_x", "openssl"]

[phases.install]
cmds = ["pnpm install --frozen-lockfile"]

[phases.build]
cmds = [
  "pnpm --filter @eft-tracker/web run prisma:generate",
  "pnpm --filter @eft-tracker/web run build"
]

[start]
cmd = "node apps/web/.next/standalone/server.js"
