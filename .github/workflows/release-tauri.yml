name: Release Tauri App

on:
  push:
    tags:
      - "tauri-v*" # Trigger on tags like tauri-v1.0.0

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: "companion-app/package-lock.json"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        working-directory: ./companion-app
        run: npm ci

      - name: Build frontend
        working-directory: ./companion-app
        run: npm run build

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          projectPath: companion-app
          tagName: ${{ github.ref_name }}
          releaseName: "EFT Tracker Companion v__VERSION__"
          releaseBody: |
            ## EFT Tracker Companion Desktop App

            Download the installer below for your platform:
            - **Windows (MSI)**: Recommended for most users
            - **Windows (NSIS)**: Alternative installer

            ### Features
            - System tray integration
            - Automatic quest progress sync from game logs
            - Syncs with your account at https://learntotarkov.com
            - Auto-updates (this and future releases will update automatically)

            ### Installation
            1. Download the installer
            2. Run the installer
            3. Launch EFT Tracker Companion from Start Menu or system tray
            4. Configure your EFT installation path if needed

            See the assets below to download.
          releaseDraft: false
          prerelease: false
