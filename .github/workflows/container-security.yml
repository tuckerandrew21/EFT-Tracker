name: Container Security Scan

on:
  pull_request:
    paths:
      - ".devcontainer/**"
      - "Dockerfile*"
      - ".dockerignore"
  push:
    branches:
      - master
      - main
    paths:
      - ".devcontainer/**"
      - "Dockerfile*"
      - ".dockerignore"
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  scan-devcontainer:
    name: Scan Dev Container
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build dev container image
        run: |
          docker build \
            -f .devcontainer/Dockerfile \
            -t eft-tracker-devcontainer:test \
            .devcontainer

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "eft-tracker-devcontainer:test"
          format: "sarif"
          output: "trivy-devcontainer-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0" # Don't fail the build, just report

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-devcontainer-results.sarif"
          category: "devcontainer"

      - name: Run Trivy in table mode for PR comments
        uses: aquasecurity/trivy-action@master
        if: github.event_name == 'pull_request'
        with:
          image-ref: "eft-tracker-devcontainer:test"
          format: "table"
          severity: "CRITICAL,HIGH"
          exit-code: "1" # Fail on HIGH/CRITICAL
          ignore-unfixed: true # Only fail on vulnerabilities with available fixes

  scan-base-image:
    name: Scan Base Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract base image from Dockerfile
        id: base-image
        run: |
          BASE_IMAGE=$(grep "^FROM" .devcontainer/Dockerfile | head -1 | awk '{print $2}')
          echo "image=$BASE_IMAGE" >> $GITHUB_OUTPUT
          echo "Scanning base image: $BASE_IMAGE"

      - name: Run Trivy on base image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.base-image.outputs.image }}
          format: "sarif"
          output: "trivy-base-image-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload base image results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-base-image-results.sarif"
          category: "base-image"

  dockerfile-lint:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint on dev Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: .devcontainer/Dockerfile
          failure-threshold: warning

      - name: Run Hadolint on production Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        if: hashFiles('Dockerfile') != ''
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [scan-devcontainer, scan-base-image, dockerfile-lint]
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "Container security scans completed"
          echo "Devcontainer scan: ${{ needs.scan-devcontainer.result }}"
          echo "Base image scan: ${{ needs.scan-base-image.result }}"
          echo "Dockerfile lint: ${{ needs.dockerfile-lint.result }}"

          if [ "${{ needs.scan-devcontainer.result }}" != "success" ] || \
             [ "${{ needs.scan-base-image.result }}" != "success" ] || \
             [ "${{ needs.dockerfile-lint.result }}" != "success" ]; then
            echo "⚠️  Some security checks failed or were skipped"
            exit 1
          else
            echo "✅ All security checks passed"
          fi
