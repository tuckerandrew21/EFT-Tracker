#!/bin/sh

# ============================================================================
# Branch Validation (prevents wrong-branch commits)
# ============================================================================

# Get current branch - ALWAYS show to provide context
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "üìç Current branch: $BRANCH"
echo ""

# HARD BLOCK: Prevent direct commits to master
if [ "$BRANCH" = "master" ]; then
  echo "‚ùå ERROR: Cannot commit directly to master branch"
  echo ""
  echo "Protected branch policy:"
  echo "  ‚Ä¢ All changes must go through Pull Requests"
  echo "  ‚Ä¢ Create a feature branch: git checkout -b feature/your-feature-name"
  echo ""
  echo "See: .claude/rules/git/protected-branches.md"
  exit 1
fi

# SOFT WARNING: Validate branch naming convention (does not block)
if ! echo "$BRANCH" | grep -qE '^(feature|fix|bugfix|hotfix|docs|refactor|test|chore)/'; then
  echo "‚ö†Ô∏è  WARNING: Branch name doesn't follow convention"
  echo ""
  echo "Current branch: $BRANCH"
  echo "Expected format: <type>/<description>"
  echo ""
  echo "Valid prefixes:"
  echo "  ‚Ä¢ feature/  - New features"
  echo "  ‚Ä¢ fix/      - Bug fixes"
  echo "  ‚Ä¢ bugfix/   - Bug fixes (alternative)"
  echo "  ‚Ä¢ hotfix/   - Critical production fixes"
  echo "  ‚Ä¢ docs/     - Documentation only"
  echo "  ‚Ä¢ refactor/ - Code refactoring"
  echo "  ‚Ä¢ test/     - Test additions"
  echo "  ‚Ä¢ chore/    - Maintenance tasks"
  echo ""
  echo "See: .claude/rules/git/branches.md"
  echo ""
  echo "‚è© Continuing anyway (this is just a warning)..."
  echo ""
fi

# ============================================================================
# Run quick validation before every commit
# This catches formatting, lint, and type errors early
# ============================================================================
echo "üîç Running pre-commit validation..."
echo ""

# Run lint-staged for quick formatting checks on staged files
if ! npx lint-staged; then
    echo ""
    echo "‚ùå Formatting/linting failed"
    exit 1
fi

echo ""
echo "‚úì Pre-commit checks passed"
echo ""
echo "üí° Tip: Before pushing to GitHub, run the full validation:"
echo "   npm run validate"
echo ""
echo "This will catch all issues (TypeScript, tests, build) before submitting your PR."
echo "(Full validation is NOT run on every commit to keep commit speed fast)"
